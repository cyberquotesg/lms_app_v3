<ion-header>
    <cq_header [title]="pageData.course.name" [displayMenu]="true" [displayNotification]="true" [displayUserMenu]="true" [displayProgress]="pageIsLoading"></cq_header>
</ion-header>

<ion-content class="cq_offline_course">
    <ion-refresher slot="fixed" [disabled]="!pageStatus" (ionRefresh)="pageRefresh($event.target)">
        <ion-refresher-content pullingText="{{ 'core.pulltorefresh' | translate }}"></ion-refresher-content>
    </ion-refresher>

    <core-loading [hideUntil]="pageStatus">
        <div class="base-background pb-5">

        <div *ngIf="isAvailable(pageData.course)">
            <ion-card>
                <div class="card-image">
                    <div *ngIf="pageData.course.courseImageFull" class="card-image-frame" [ngStyle]="{'background-image': 'url(' + pageData.course.courseImageFull + ')'}"></div>
                    <span *ngIf="!pageData.course.courseImageFull" class="card-image-letter">{{ getLetter(pageData.course.name) }}</span>

                    <div class="text-right" style="position: absolute; left: 4px; top: 4px; right: 4px;">
                        <cq_tags [item]="pageData.course"></cq_tags>
                    </div>
                </div>

                <ion-card-header>
                    <ion-card-title class="text-center">{{ pageData.course.name }}</ion-card-title>
                </ion-card-header>

                <ion-card-content>
                    <!-- about -->
                    <p><b>Description</b></p>
                    <p class="no-break">{{ pageData.course.description ? sanitizeHTML(pageData.course.description) : '-' }}</p>

                    <p class="mt-cs"><b>Organizer</b></p>
                    <p class="no-break">{{ pageData.course.organizerText }}</p>

                    <p class="mt-cs"><b>Product Group</b></p>
                    <p class="no-break">{{ pageData.course.productGroupText }}</p>

                    <p class="mt-cs"><b>CPD Hour{{ s(pageData.course.cpdHours) }}</b></p>
                    <p class="no-break">{{ pageData.course.cpdHours }} CPD Hour{{ s(pageData.course.cpdHours) }}</p>

                    <!-- enrolled -->
                    <ng-container *ngIf="pageData.course.hasOneBatchEnrolled">
                        <ng-container *ngFor="let session of pageData.sessions; let i = index">

                            <ng-container *ngIf="session.userEnrolment == '1'">
                                <p class="mt-cs"><b>Enrolment Status</b></p>
                                <p class="no-break">In Waiting List</p>
                            </ng-container>

                            <ng-container *ngIf="session.userEnrolment == '1' || session.userEnrolment == '2'">
                                <p class="mt-cs"><b>Course Batch</b></p>
                                <p class="no-break">Batch - {{ session.startDateText }}</p>

                                <p class="mt-cs"><b>Date &amp; Time</b></p>
                                <p class="no-break">{{ session.sessionTimeRange }}</p>

                                <p class="mt-cs"><b>Withdrawal Administrator</b></p>
                                <p class="no-break">{{ session.withdrawalAdministratorText }}</p>

                                <p class="mt-cs"><b>Withdrawal Deadline</b></p>
                                <p class="no-break">{{ session.withdrawalDeadlineText }}</p>

                                <p class="mt-cs"><b>Attendance Method{{ s(session.attendanceMethods) }}</b></p>
                                <p class="no-break">{{ to_comma_separated_text(session.attendanceMethods) }}</p>

                                <ng-container *ngIf="!session.zoomMeeting || (session.zoomMeeting && session.retainQrCodeChecklog)">
                                    <p class="mt-cs"><b>Location</b></p>
                                    <p class="no-break">{{ session.venue }}</p>
                                    <p class="no-break mt-4" *ngIf="session.userEnrolment == '2' && session.latitude && session.longitude && session.latitude != '0' && session.longitude != '0'">
                                        <button (click)="openMap(session)">
                                            <img src="assets/img/icons/{{ pageData.isIos ? 'apple' : 'google' }}_map.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                            <span style="vertical-align: middle; margin-left: 4px;">View in Map</span>
                                        </button>
                                    </p>
                                </ng-container>
                            </ng-container>

                            <!-- information for ongoing course -->
                            <ng-container *ngIf="session.userEnrolment == '2'">
                                <ng-container *ngIf="session.calendarButtons.google || session.calendarButtons.outlook || (pageData.isIos && session.calendarButtons.apple)">
                                    <ng-container *ngIf="!session.sessionHasEnded">
                                        <p class="mt-cs"><b>Save to Calendar</b></p>
                                        <p class="no-break mt-4">
                                            <button *ngIf="session.calendarButtons.google" class="mr-cs" (click)="openInBrowser(session.calendarButtons.google)">
                                                <img src="assets/img/icons/google_calendar.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                <span style="vertical-align: middle; margin-left: 4px;">Google</span>
                                            </button>
                                            <button *ngIf="session.calendarButtons.outlook" class="mr-cs" (click)="openInBrowser(session.calendarButtons.outlook)">
                                                <img src="assets/img/icons/outlook.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                <span style="vertical-align: middle; margin-left: 4px;">Outlook</span>
                                            </button>
                                            <button *ngIf="pageData.isIos && session.calendarButtons.apple" class="mr-cs" (click)="openInBrowser(session.calendarButtons.apple)">
                                                <img src="assets/img/icons/apple_calendar.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                <span style="vertical-align: middle; margin-left: 4px;">Apple</span>
                                            </button>
                                        </p>
                                    </ng-container>
                                </ng-container>
                            </ng-container>

                        </ng-container>
                    </ng-container>
                </ion-card-content>
            </ion-card>

            <!-- not enrolled -->
            <ng-container *ngIf="!pageData.course.hasOneBatchEnrolled">
                <div class="main-font text-left" class="pl-20 pr-20 mt-28 text-left" style="font-size: 16px;">
                    Choose Your Intake
                    <div class="gradient-background" style="height: 4px;border-radius: 0px 2px 2px 0px;margin-top: 12px;margin-left: -20px;"></div>
                </div>

                <!-- has batch -->
                <ng-container *ngIf="pageData.course.hasBatch">
                    <ion-card *ngFor="let session of pageData.sessions">
                        <ion-card-content>
                            <div class="session-wrapper">

                                <div class="session">
                                    <div class="session-info">
                                        <div class="card-item">
                                            <div class="card-item-icon">
                                                <ion-icon name="bookmark"></ion-icon>
                                            </div>
                                            <div class="card-item-text">Batch - {{ session.startDateText }}</div>
                                        </div>

                                        <div class="card-item">
                                            <div class="card-item-icon">
                                                <ion-icon name="time"></ion-icon>
                                            </div>
                                            <div class="card-item-text">{{ session.sessionTimeRange }}</div>
                                        </div>

                                        <div class="card-item">
                                            <div class="card-item-icon">
                                                <ion-icon name="school"></ion-icon>
                                            </div>
                                            <div class="card-item-text">{{ to_comma_separated_text(session.attendanceMethods) }}</div>
                                        </div>

                                        <div *ngIf="!session.zoomMeeting || (session.zoomMeeting && session.retainQrCodeChecklog)" class="card-item">
                                            <div class="card-item-icon">
                                                <ion-icon name="map"></ion-icon>
                                            </div>
                                            <div class="card-item-text">{{ session.venue }}</div>
                                        </div>
                                        
                                        <div class="card-item">
                                            <div class="card-item-icon">
                                                <ion-icon name="people"></ion-icon>
                                            </div>
                                            <div class="card-item-text">
                                                <span *ngIf="session.availableSeat > 0">{{ session.availableSeat }} Seat{{ s(session.availableSeat) }} Available</span>
                                                <span *ngIf="session.availableSeat == 0">Full</span>
                                            </div>
                                        </div>

                                        <div class="card-item">
                                            <button *ngIf="session.unavailableMessage == ''" (click)="takeSession(session)" class="full {{ loading ? 'active' : '' }}">
                                                <span *ngIf="!loading"><b>Enrol</b></span>
                                                <ion-spinner *ngIf="loading"></ion-spinner>
                                            </button>

                                            <div *ngIf="session.unavailableMessage != ''" class="no-break text-center pl-12 pt-12 pr-12 pb-12 background-red color-white" style="border-radius: 12px;">
                                                {{ session.unavailableMessage }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </ion-card-content>
                    </ion-card>
                </ng-container>

                <!-- no batch -->
                <ion-card *ngIf="!pageData.course.hasBatch">
                    <ion-card-content>
                        <div class="pt-cst pb-cst text-center">This course has no batch</div>
                    </ion-card-content>
                </ion-card>
            </ng-container>

            <!-- enrolled -->
            <ng-container *ngIf="pageData.course.hasOneBatchEnrolled">
                <ng-container *ngFor="let session of pageData.sessions; let i = index">
                    <!-- progress card for enrolled course -->
                    <div *ngIf="session.userEnrolment == '2'">

                        <!-- course status -->
                        <div class="main-font text-left" class="pl-cs pr-cs mt-28 text-left" style="font-size: 16px;">
                            Progress
                            <div class="cq-tag-wrapper" style="float: right; margin-top: -8px;">
                                <div class="cq-tag {{ session.userAttendance == 'accredited' ? 'green' : 'dark-grey' }}">
                                    <ion-icon *ngIf="session.userAttendance == 'accredited'" name="checkmark-circle" style="vertical-align: text-bottom; padding-right: 2px;"></ion-icon>
                                    {{ session.userAttendanceText }}
                                </div>
                            </div>

                            <div class="gradient-background" style="height: 4px;border-radius: 0px 2px 2px 0px;margin-top: 12px;margin-left: -20px;"></div>
                        </div>
                        <div class="course-status">
                            <ion-card>
                                <ion-card-content>
                                    <!-- has not started -->
                                    <div *ngIf="!session.sessionHasStarted" class="pt-cst pb-cst text-center">
                                        <cq_will_start_in [unixtimestamp]="session.willStartIn" [big]="session.willStartInMoving <= 3600" [animation]="true" (onZero)="timeHasCome($event, i)"></cq_will_start_in>
                                    </div>

                                    <!-- has started -->
                                    <div *ngIf="session.sessionHasStarted && !session.sessionHasEnded" class="pt-cst pb-cst text-center">
                                        Course is ongoing
                                    </div>

                                    <!-- has ended -->
                                    <div *ngIf="session.sessionHasEnded" class="pt-cst pb-cst text-center">
                                        Course has ended
                                    </div>
                                </ion-card-content>
                            </ion-card>
                        </div>

                        <!-- session progress -->
                        <div class="session-progress">
                            <!-- zoom meeting -->
                            <ng-container *ngIf="session.zoomMeeting">
                                <ng-container *ngFor="let date of session.dates">
                                    <ng-container *ngIf="date.dateHasNextTime">

                                        <ion-card>
                                            <ion-card-header>
                                                Zoom Meeting
                                            </ion-card-header>

                                            <ion-card-content>
                                                <div>
                                                    <ng-container *ngIf="session.buttonIsAlive">
                                                        <button *ngIf="date.zoomMeetingid && date.zoomMeetingPassword" class="full" (click)="joinMeetingZoom(date.zoomMeetingid, date.zoomMeetingPassword)">
                                                            <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                            <span style="vertical-align: middle; margin-left: 4px;">Join In App</span>
                                                        </button>
                                                        <button *ngIf="!date.zoomMeetingid || !date.zoomMeetingPassword" class="full" disabled>
                                                            <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                            <span style="vertical-align: middle; margin-left: 4px;">Join In App</span>
                                                        </button>

                                                        <button *ngIf="date.zoomRegistrationUrl" class="full mt-cs" (click)="openInBrowser(date.zoomRegistrationUrl)">
                                                            <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                            <span style="vertical-align: middle; margin-left: 4px;">Join In Browser</span>
                                                        </button>
                                                        <button *ngIf="!date.zoomRegistrationUrl" class="full mt-cs" disabled>
                                                            <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                            <span style="vertical-align: middle; margin-left: 4px;">Join In Browser</span>
                                                        </button>
                                                    </ng-container>

                                                    <ng-container *ngIf="!session.buttonIsAlive">
                                                        <button class="full" disabled>
                                                            <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                            <span style="vertical-align: middle; margin-left: 4px;">Join In App</span>
                                                        </button>
                                                        <button class="full mt-cs" disabled>
                                                            <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                            <span style="vertical-align: middle; margin-left: 4px;">Join In Browser</span>
                                                        </button>
                                                    </ng-container>
                                                </div>
                                                
                                                <div>
                                                    <button *ngIf="date.zoomInvitation" class="full mt-cs" (click)="openZoomInvitation(date.zoomInvitation)">
                                                        <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                        <span style="vertical-align: middle; margin-left: 4px;">Open Zoom Invitation</span>
                                                    </button>
                                                    <button *ngIf="!date.zoomInvitation" class="full mt-cs" disabled>
                                                        <img src="assets/img/icons/zoom_meeting.png" style="display: inline-block; width: 21px; height: 21px; vertical-align: middle;" />
                                                        <span style="vertical-align: middle; margin-left: 4px;">Zoom Invitation Is Not Available</span>
                                                    </button>
                                                </div>
                                            </ion-card-content>
                                        </ion-card>

                                    </ng-container>
                                </ng-container>
                            </ng-container>

                            <!-- checklog -->
                            <ion-card *ngIf="!session.zoomMeeting || (session.zoomMeeting && session.retainQrCodeChecklog)">
                                <ion-card-header>
                                    Checklog
                                </ion-card-header>

                                <ion-card-content>
                                    <!-- scan qr code -->
                                    <div class="qr-scanner-button mb-cs">
                                        <div *ngIf="session.buttonIsAlive" class="button" (click)="scanQRCode(session)">
                                            <ion-icon class="button-big pl-10 pr-10" name='scan-outline'></ion-icon>
                                            <ion-icon class="button-small" name='qr-code-outline'></ion-icon>
                                        </div>

                                        <div *ngIf="!session.buttonIsAlive" class="button disabled">
                                            <ion-icon class="button-big pl-10 pr-10" name='scan-outline'></ion-icon>
                                            <ion-icon class="button-small" name='qr-code-outline'></ion-icon>
                                        </div>
                                    </div>

                                    <!-- table -->
                                    <table style="max-width: 100%; margin: 0px auto">
                                        <tr *ngFor="let checklog of session.checklogs; let i = index">
                                            <td class="{{ i ? 'pt-12' : '' }}" style="vertical-align: top;">
                                                CHECKLOG {{ checklog.inOut }}<br />
                                                <small>{{ checklog.date }} {{ time24To12(checklog.time) }}</small>

                                                <!-- this is only for development -->
                                                <div *ngIf="isDevelopment()" class="mt-cs mb-cs text-center">
                                                    <button (click)="fakeScanQRCode(session, checklog)">
                                                        Fake Check {{ checklog.inOut }}
                                                    </button>
                                                    <button class="ml-cs" (click)="fakeChecklogBanner(checklog)">
                                                        Fake Banner
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="pl-20 pr-20 text-center {{ i ? 'pt-12' : '' }}" style="vertical-align: top;">:</td>
                                            <td class="text-right {{ i ? 'pt-12' : '' }}" style="vertical-align: top;">
                                                <span *ngIf="checklog.status == '-1' && session.userAttendance != 'accredited'">{{checklog.statusText}}</span>

                                                <span *ngIf="checklog.status == '0' && session.userAttendance != 'accredited'">
                                                    <ion-icon name="close-circle" (click)="showRejectedReason(checklog.message)" class="color-red" style="font-size: 20px;"></ion-icon>
                                                </span>

                                                <span *ngIf="checklog.status == '1' || session.userAttendance == 'accredited'">
                                                    <ion-icon name="checkmark-circle" class="color-green" style="font-size: 20px;"></ion-icon>
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </ion-card-content>
                            </ion-card>
                        </div>

                        <!-- withdrawal -->
                        <div class="main-font text-left" class="pl-cs pr-cs mt-28 text-left" style="font-size: 16px;">
                            Withdrawal
                            <div class="gradient-background" style="height: 4px;border-radius: 0px 2px 2px 0px;margin-top: 12px;margin-left: -20px;"></div>
                        </div>
                        <div class="withdrawal">
                            <ion-card>
                                <ion-card-content>
                                    <button *ngIf="session.unavailableMessage == ''" (click)="leaveSession(session)" class="full {{ loading ? 'active' : '' }}">
                                        <span *ngIf="!loading"><b class="color-red">Withdraw</b></span>
                                        <ion-spinner *ngIf="loading"></ion-spinner>
                                    </button>

                                    <div *ngIf="session.unavailableMessage != ''" class="pt-cst pb-cst text-center color-red">
                                        {{ session.unavailableMessage }}
                                    </div>
                                </ion-card-content>
                            </ion-card>
                        </div>
                    </div>
                </ng-container>
            </ng-container>
        </div>

        <cq_empty [empty]="isEmpty(pageData.course)"></cq_empty>

        </div>
    </core-loading>
</ion-content>
